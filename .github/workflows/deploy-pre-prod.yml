name: "Deploy - Pre-prod"

run-name: "${{ github.event.inputs.branch_or_tag }}"

on:
  workflow_dispatch:
    inputs:
      branch_or_tag:
        description: "Branch or tag to deploy"
        required: true
        type: string
        default: main

permissions:
  pull-requests: write
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

jobs:
  tag_main:
    name: Tag main
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.versioning.outputs.tag || github.event.inputs.branch_or_tag }}
    permissions: write-all
    steps:
      - name: Checkout main
        if: ${{ github.event.inputs.branch_or_tag == 'main' }}
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: "0"

      - name: Bump version and push tag
        if: ${{ github.event.inputs.branch_or_tag == 'main' }}
        id: versioning
        uses: anothrNick/github-tag-action@1.64.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: false
          DEFAULT_BUMP: patch

      - name: View outputs
        run: |
          echo Tag to deploy: ${{ steps.versioning.outputs.tag || github.event.inputs.branch_or_tag }}

  terraform_plan_apply_base_iam:
    name: Terraform Plan/Apply base-iam (pre-prod)
    runs-on: ubuntu-latest
    needs: ["tag_main"]
    environment: pre-prod
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.tag_main.outputs.version }}
          fetch-depth: "0"

      - name: Apply base_iam
        uses: ./.github/actions/tf-plan-apply
        with:
          aws_assume_role: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/pre-prod-github-bootstrap
          bucket_prefix: "pre-prod"
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_region: ${{ vars.AWS_REGION }}
          working_directory: "./base_iam"  # Use separate base_iam directory
          workspace: ${{ secrets.AWS_WORKSPACE }}
          tf_vars_file: ${{ vars.TF_VARS_FILE }}
          tf_extra_args: "-var aws_account_id=${{ secrets.AWS_ACCOUNT_ID }}"


  terraform_plan_apply:
    name: Terraform Plan/Apply infrastructure (pre-prod)
    runs-on: ubuntu-latest
    needs: ["tag_main", "terraform_plan_apply_base_iam"]
    environment: pre-prod
    steps:
      - name: Checkout main
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.tag_main.outputs.version }}
          fetch-depth: "0"

      - name: Apply Main
        uses: ./.github/actions/tf-plan-apply
        with:
          # use newly updated role
          aws_assume_role: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/pre-prod-github-actions-role
          bucket_prefix: "pre-prod"
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_region: ${{ vars.AWS_REGION }}
          workspace: ${{ secrets.AWS_WORKSPACE }}
          tf_vars_file: ${{ vars.TF_VARS_FILE }}
