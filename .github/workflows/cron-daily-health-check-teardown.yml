name: "Z-CRON: Daily health check - Teardown"

on:
  push:
    branches:
      - PRMP-631
  schedule:
    - cron: 30 6 * * 1-5

permissions:
  actions: read # Required for anchore/sbom-action
  contents: write # Required for anchore/sbom-action
  pull-requests: write
  id-token: write

jobs:
  set_workspace:
    name: Set Workspace (ndrd)
    runs-on: ubuntu-latest
    outputs:
      workspace: ${{ steps.set-output.outputs.workspace }}
    steps:
      - name: Set Output
        id: set-output
        run: echo 'workspace=ndrd' >> $GITHUB_OUTPUT

  destroy_test_environment:
    name: Destroy Sandbox (ndrd)
    needs: ["set_workspace"]
    uses: ./.github/workflows/tear-down-sandbox.yml
    with:
      git_ref: main
      sandbox_name: ${{ needs.set_workspace.outputs.workspace }}
      environment: development
    secrets: inherit

  notify-slack:
    name: Notify Slack on Failure
    runs-on: ubuntu-latest
    environment: development
    needs: [destroy_test_environment]
    if: failure()
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ASSUME_ROLE }}
          role-skip-session-tagging: true
          aws-region: ${{ vars.AWS_REGION }}
          mask-aws-account-id: true

      - name: Get slack bot token from SSM parameter store
        run: |
          slack_bot_token=$(aws ssm get-parameter --name "/ndr/alerting/slack/bot_token" --with-decryption --query "Parameter.Value" --output text)
          echo "::add-mask::$slack_bot_token"
          echo "SLACK_BOT_TOKEN=$slack_bot_token" >> $GITHUB_ENV

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ env.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.ALERTS_SLACK_CHANNEL_ID }}",
              "attachments": [
                {
                  "color": "#ff0000",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "‚ùå Workflow `${{ github.workflow }}` failed"
                      }
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Triggered by:* `Scheduled Job`\n*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.workflow }}>"
                      }
                    },
                    {
                      "type": "divider"
                    },
                    {
                      "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*terraform_plan_apply:* ${{ needs.terraform_plan_apply.result == 'success' && ':white_check_mark:' || ':x:' }}" },
                        { "type": "mrkdwn", "text": "*run_lambda_unit_tests:* ${{ needs.run_lambda_unit_tests.result == 'success' && ':white_check_mark:' || ':x:' }}" },
                        { "type": "mrkdwn", "text": "*run_ui_unit_tests:* ${{ needs.run_ui_unit_tests.result == 'success' && ':white_check_mark:' || ':x:' }}" },
                        { "type": "mrkdwn", "text": "*run_cypress_tests:* ${{ needs.run_cypress_tests.result == 'success' && ':white_check_mark:' || ':x:' }}" },
                        { "type": "mrkdwn", "text": "*publish_lambda_layers:* ${{ needs.publish_lambda_layers.result == 'success' && ':white_check_mark:' || ':x:' }}" },
                        { "type": "mrkdwn", "text": "*deploy_lambdas:* ${{ needs.deploy_lambdas.result == 'success' && ':white_check_mark:' || ':x:' }}" },
                        { "type": "mrkdwn", "text": "*deploy_ui:* ${{ needs.deploy_ui.result == 'success' && ':white_check_mark:' || ':x:' }}" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "Environment: `development` | Sandbox: `${{ needs.set_workspace.outputs.workspace }}`" }
                      ]
                    }
                  ]
                }
              ]
            }
